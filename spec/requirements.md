# ナレッジ管理ツール - 要件定義書

## 1. 要件概要

### **1.1 要件定義の目的**
本要件定義書は、ナレッジ管理ツール「KnowledgeFlow」の開発において、システムが満たすべき機能要件・非機能要件を詳細に定義し、開発・テスト・検収の基準を明確化することを目的とする。

### **1.2 要件の分類**
- **機能要件（FR: Functional Requirements）**: システムが提供すべき機能
- **非機能要件（NFR: Non-Functional Requirements）**: 性能・品質・制約に関する要件
- **制約要件（CR: Constraint Requirements）**: 技術・環境・運用に関する制約

### **1.3 要件の優先度**
- **必須（Must）**: システム稼働に不可欠な要件
- **重要（Should）**: 実用性確保に重要な要件
- **任意（May）**: あれば望ましい要件

## 2. 機能要件（Functional Requirements）

### **2.1 ナレッジ作成機能**

#### **FR-001: タネ投入機能【必須】**
**要件ID**: FR-001  
**優先度**: Must 
**概要**: ユーザーがURL・テキストを入力してナレッジの元データを投入する

**詳細仕様**:
- ユーザーはWebフォームからURL、テキストのいずれかを投入できる
- URL投入時、システムは自動的にWebページの内容を取得・解析する
- テキスト投入時、システムは入力されたテキストをそのまま処理対象とする

**受け入れ条件**:
```
Given: ユーザーがナレッジ作成画面を表示している
When: 有効なURL「https://example.com/article」を入力して作成ボタンをクリック
Then: システムがURLの内容を取得し、処理中画面が表示される
And: 30秒以内に次の処理（AI加工）に進む

Given: ユーザーがナレッジ作成画面を表示している  
When: テキスト「今日の実験結果: CTRが0.5%から1.2%に改善」を入力して作成ボタンをクリック
Then: システムがテキストを受け付け、処理中画面が表示される
And: 10秒以内に次の処理（AI加工）に進む
```

**エラー処理**:
- 無効なURL: エラーメッセージ表示「有効なURLを入力してください」
- アクセス不可URL: 手動テキスト入力への誘導
- サイズ制限超過: 警告メッセージと分割入力の提案

#### **FR-002: AI自動加工機能【必須】**
**要件ID**: FR-002  
**優先度**: Must
**概要**: 投入されたタネをその種別によりAIにより構造化・分類・要約する

**詳細仕様**:
- システムは外部AI API（OpenAI GPT-4以上。モデルは指定可能に）を利用してコンテンツを解析する
- 抽出項目：タイトル、要約、問題、解決策、結果、制約、洞察、キーワード、カテゴリ
- 処理時間制限：URL解析15秒、テキスト処理10秒以内

**受け入れ条件**:
```
Given: 有効なタネデータが投入されている
When: AI処理が実行される
Then: 以下の構造化データが生成される:
  - title: 空文字でない文字列
  - summary: 200文字以内の要約
  - blocks: 最低1つのブロック（problem/solution/result/insight）
  - keywords: 3-10個のキーワード配列
  - category: システム定義カテゴリのいずれか
And: 処理時間が制限時間内である
```

**カテゴリ定義**:
- マーケティング
- 開発・技術
- 営業・顧客対応
- 業務改善・効率化
- その他
など。

#### **FR-003: ナレッジ編集機能【必須】**
**要件ID**: FR-003  
**優先度**: Must
**概要**: AI生成されたナレッジを手動で編集・調整する

**詳細仕様**:
- ユーザーは生成されたすべてのフィールドを編集可能
- ブロックの追加・削除・並び替えが可能
- キーワードの追加・削除が可能
- 自動保存機能（3秒間隔）
- 編集履歴の保持（最新5版まで）

**受け入れ条件**:
```
Given: AI生成されたナレッジが表示されている
When: ユーザーがタイトルフィールドをクリックして「新しいタイトル」に変更
Then: フィールドが編集可能状態になる
And: 変更が自動保存される
And: 画面上に「保存済み」インジケーターが表示される

Given: ナレッジ編集画面が表示されている
When: ユーザーが「制約・条件」ブロックを削除
Then: 該当ブロックが画面から消える
And: 削除操作が自動保存される
```

#### **FR-004: メタデータ自動生成機能【重要】**
**要件ID**: FR-004
**優先度**: Should  
**概要**: ナレッジの品質・信頼性・鮮度に関するメタデータを自動生成する

**詳細仕様**:
- 作成日時・更新日時の自動記録
- 情報源URL・参照情報の自動保持
- 推定有効期限の算出（情報の性質に基づき1ヶ月-1年の範囲）
- 品質スコアの算出（完全性・一貫性に基づき0-100点）
- 利用統計の自動更新（参照回数・最終利用日）

**受け入れ条件**:
```
Given: 新しいナレッジが作成される
When: ナレッジがデータベースに保存される
Then: 以下のメタデータが自動生成される:
  - created_at: 現在日時
  - updated_at: 現在日時
  - estimated_expiry: 作成日から30日-365日後の日付
  - view_count: 0で初期化
```

### **2.2 検索・発見機能**

#### **FR-005: 基本検索機能【必須】**
**要件ID**: FR-005  
**優先度**: Must  
**概要**: キーワードによる全文検索機能を提供する

**詳細仕様**:
- 検索対象：タイトル、要約、すべてのブロック内容、キーワード
- 部分一致・AND/OR検索をサポート
- 検索結果は関連度順でソート
- 検索結果には該当箇所のハイライト表示
- 結果件数の表示

**受け入れ条件**:
```
Given: システムに「SNS広告CTR改善事例」というナレッジが存在する
When: ユーザーが検索フィールドに「CTR」を入力して検索実行
Then: 該当ナレッジが検索結果に表示される
And: 「CTR」部分がハイライトされる
And: 検索処理が2秒以内に完了する

Given: システムに複数のナレッジが存在する
When: ユーザーが「マーケティング 改善」で検索実行
Then: 両方のキーワードを含むナレッジが優先表示される
And: いずれかのキーワードを含むナレッジも関連度順で表示される
```

#### **FR-006: カテゴリ・フィルタ機能【必須】**
**要件ID**: FR-006  
**優先度**: Must  
**概要**: カテゴリ・作成日・品質スコア等によるフィルタ機能

**詳細仕様**:
- カテゴリフィルタ：定義済みカテゴリからの選択
- 日付フィルタ：過去1週間/1ヶ月/3ヶ月/期間指定
- 品質フィルタ：品質スコア閾値による絞り込み
- 利用頻度フィルタ：参照回数による絞り込み
- 複数フィルタの同時適用が可能
- フィルタ条件の保存・呼び出し

**受け入れ条件**:
```
Given: 複数カテゴリのナレッジが存在する
When: ユーザーがカテゴリフィルタで「マーケティング」を選択
Then: マーケティングカテゴリのナレッジのみが表示される
And: 表示件数が更新される
And: フィルタ適用状態が視覚的に示される

Given: フィルタが適用されている状態
When: ユーザーが日付フィルタ「過去1ヶ月」を追加選択
Then: マーケティングかつ過去1ヶ月以内のナレッジのみが表示される
And: 両方のフィルタが適用状態として表示される
```

#### **FR-007: 関連ナレッジ提案機能【重要】**
**要件ID**: FR-007  
**優先度**: Should  
**概要**: 閲覧中のナレッジに関連する他のナレッジを自動提案する

**詳細仕様**:
- キーワード一致・カテゴリ一致・内容類似度による関連性計算
- 関連度スコア0.3以上のナレッジを最大5件表示
- 閲覧履歴を考慮した推薦（既読は優先度下位）
- 新しいナレッジを優先する時間重み付け

**受け入れ条件**:
```
Given: 「SNS広告CTR改善」ナレッジを閲覧中
When: ナレッジ詳細画面が表示される
Then: 画面下部に「関連するナレッジ」セクションが表示される
And: 「広告」「CTR」「SNS」等のキーワードが一致するナレッジが提案される
And: 最大5件まで表示される
And: 関連度の高い順に並んでいる
```

### **2.3 アウトプット生成機能**

#### **FR-008: 基本エクスポート機能【必須】**
**要件ID**: FR-008  
**優先度**: Must  
**概要**: ナレッジを実用的な形式で出力する

**詳細仕様**:
- 出力形式：チェックリスト、サマリー、詳細レポート
- ファイル形式：Markdown、プレーンテキスト
- 単一ナレッジからの生成
- 生成ファイルのローカル保存
- ダウンロード機能の提供

**受け入れ条件**:
```
Given: ナレッジ詳細画面を表示中
When: ユーザーが「チェックリスト形式でエクスポート」を選択
Then: 以下の構造のMarkdownファイルが生成される:
  # [ナレッジタイトル] チェックリスト
  ## 準備
  - [ ] [制約条件から抽出された準備項目]
  ## 実行
  - [ ] [解決策から抽出された実行項目]
  ## 確認
  - [ ] [結果から抽出された確認項目]
And: ファイルダウンロードが自動的に開始される
And: 生成処理が5秒以内に完了する
```

#### **FR-009: 複数ナレッジ統合機能【重要】**
**要件ID**: FR-009  
**優先度**: Should  
**概要**: 複数のナレッジを統合した総合レポートを生成する

**詳細仕様**:
- 最大10件のナレッジを選択して統合
- 時系列・カテゴリ別・テーマ別の構成パターン
- 重複内容の自動マージ・統合
- 統合レポートの自動見出し生成
- PDF形式での出力対応

**受け入れ条件**:
```
Given: ユーザーが3件のマーケティング関連ナレッジを選択
When: 「統合レポート生成」を実行
Then: 以下の構造のレポートが生成される:
  # マーケティング施策まとめレポート
  ## 概要
  ## 実施した施策
  ### 施策1: [ナレッジ1のタイトル]
  ### 施策2: [ナレッジ2のタイトル]  
  ### 施策3: [ナレッジ3のタイトル]
  ## 共通する学び
  ## 今後の改善提案
And: 生成処理が30秒以内に完了する
```

### **2.4 データ管理機能**

#### **FR-010: ナレッジ一覧表示機能【必須】**
**要件ID**: FR-010  
**優先度**: Must  
**概要**: 登録済みナレッジを一覧形式で表示する

**詳細仕様**:
- カード形式での一覧表示（タイトル・要約・作成日・カテゴリ）
- ソート機能：作成日・更新日・タイトル・カテゴリ・品質スコア
- ページング：20件/ページ
- 一括選択・削除機能
- 表示形式の切替（カード・リスト）

**受け入れ条件**:
```
Given: システムに複数のナレッジが登録されている
When: ユーザーがメイン画面を表示
Then: ナレッジが20件まで一覧表示される
And: 各項目にタイトル・要約（100文字）・作成日・カテゴリが表示される
And: ページング機能で次のページに遷移できる
And: 各ソート項目で並び順を変更できる
```

#### **FR-011: ナレッジ詳細表示機能【必須】**
**要件ID**: FR-011  
**優先度**: Must  
**概要**: 選択したナレッジの詳細情報を表示する

**詳細仕様**:
- 全ブロックの詳細内容表示
- メタデータ情報の表示
- 編集モードへの切替機能
- エクスポート機能へのアクセス
- 関連ナレッジの表示

**受け入れ条件**:
```
Given: ナレッジ一覧画面を表示中
When: ユーザーが特定のナレッジをクリック
Then: ナレッジ詳細画面に遷移する
And: 以下の情報が表示される:
  - タイトル
  - 要約
  - 全ブロック内容（問題・解決策・結果・制約・洞察）
  - キーワード一覧
  - 作成日・更新日
  - 品質スコア・信頼度
And: 編集ボタンとエクスポートボタンが表示される
```

#### **FR-012: ナレッジ削除機能【必須】**
**要件ID**: FR-012  
**優先度**: Must  
**概要**: 不要なナレッジを削除する

**詳細仕様**:
- 論理削除による削除実行（物理削除は管理機能として別途）
- 削除前の確認ダイアログ表示
- 一括削除機能（複数選択）
- 削除済みナレッジの復旧機能（30日間）

**受け入れ条件**:
```
Given: ナレッジ詳細画面を表示中
When: ユーザーが削除ボタンをクリック
Then: 確認ダイアログが表示される「本当にこのナレッジを削除しますか？」
And: 「削除」ボタンと「キャンセル」ボタンが表示される

Given: 削除確認ダイアログが表示されている
When: ユーザーが「削除」をクリック
Then: ナレッジが削除される（論理削除）
And: 一覧画面に戻る
And: 削除されたナレッジは通常の検索・一覧から除外される
```

## 3. 非機能要件（Non-Functional Requirements）

### **3.1 性能要件**

#### **NFR-001: 応答時間要件【必須】**
**要件ID**: NFR-001  
**優先度**: Must  
**概要**: ユーザー操作に対する応答時間の上限を定義

**詳細仕様**:
```yaml
基本操作:
  - 画面遷移: 1秒以内
  - 一覧表示: 2秒以内
  - 詳細表示: 1秒以内
  - 保存操作: 500ms以内

AI処理:
  - テキスト処理: 10秒以内
  - URL解析: 15秒以内  
  - 処理失敗時タイムアウト: 30秒

検索・フィルタ:
  - キーワード検索: 2秒以内
  - フィルタ適用: 1秒以内
  - 関連ナレッジ提案: 3秒以内

エクスポート:
  - 単一ナレッジ: 5秒以内
  - 複数ナレッジ統合: 30秒以内
```

**測定方法**: 
- 自動テストによる処理時間測定
- ユーザビリティテストでの体感速度評価
- 本番環境での継続的モニタリング

#### **NFR-002: スループット要件【重要】**
**要件ID**: NFR-002  
**優先度**: Should
**概要**: 同時処理可能な操作数の下限を定義

**詳細仕様**:
- 同時ナレッジ作成: 5件まで
- 同時検索処理: 10件まで
- 同時エクスポート: 3件まで
- AI API呼び出し: 毎分20回まで（OpenAI制限考慮）

**測定方法**:
- 負荷テストツールによる並行処理テスト
- AI API レート制限の監視

#### **NFR-003: リソース使用量要件【重要】**
**要件ID**: NFR-003  
**優先度**: Should  
**概要**: システムリソース使用量の上限を定義

**詳細仕様**:
```yaml
メモリ使用量:
  - 平常時: 500MB以下
  - AI処理時: 1GB以下
  - データベースキャッシュ: 100MB以下

CPU使用率:
  - 平常時: 10%以下
  - AI処理時: 50%以下（1分間継続まで）
  
ディスク使用量:
  - アプリケーション: 200MB以下
  - データベース: 初期10MB、最大1GB
  - ログファイル: 最大100MB（ローテーション）
```

### **3.2 可用性要件**

#### **NFR-004: システム稼働率【必須】**
**要件ID**: NFR-004  
**優先度**: Must  
**概要**: システムの稼働率目標値

**詳細仕様**:
- ローカル稼働率: 99.0%以上（年間ダウンタイム87.6時間以下）
- 外部API依存部分除く基本機能: 99.5%以上
- 計画停止（アップデート等）: 月間1時間以下

**測定方法**:
- システム監視による稼働状況記録
- エラーログによる障害時間の算出
- ユーザー報告による実稼働時間の確認

### **3.3 セキュリティ要件**

#### **NFR-005: データ保護要件【必須】**
**要件ID**: NFR-005  
**優先度**: Must  
**概要**: データの保護・機密性要件

**詳細仕様**:
- ローカルデータ保存: SQLiteファイルの適切なアクセス権限設定
- API キー管理: 環境変数・設定ファイル暗号化保存
- ログデータ保護: 個人情報・機密情報のログ出力除外
- データバックアップ: 自動バックアップ機能（日次）

#### **NFR-006: 外部通信セキュリティ【重要】**
**要件ID**: NFR-006 
**優先度**: Should  
**概要**: 外部API通信時のセキュリティ要件

**詳細仕様**:
- HTTPS通信: 全外部API呼び出しでHTTPS必須
- API認証: 適切なAPIキー・トークン管理
- データ最小化: 必要最小限のデータのみ外部送信
- 通信ログ: 外部API呼び出し履歴の記録（APIキー除く）

### **3.4 ユーザビリティ要件**

#### **NFR-007: 操作性要件【必須】**
**要件ID**: NFR-007  
**優先度**: Must  
**概要**: システムの使いやすさに関する要件

**詳細仕様**:
- 学習時間: 初回利用から基本操作まで15分以内
- エラーメッセージ: 分かりやすい日本語での説明
- 操作ガイド: 主要機能のツールチップ・ヘルプ表示
- キーボードショートカット: 基本操作のショートカット対応

**測定方法**:
- ユーザビリティテストによる操作時間測定
- タスク完了率・エラー率の測定
- ユーザーフィードバックによる満足度評価

### **3.5 互換性・移植性要件**

#### **NFR-008: OS互換性【必須】**
**要件ID**: NFR-008  
**優先度**: Must  
**概要**: 対応OSの定義

**詳細仕様**:
```yaml
対応OS:
  - Windows: 10, 11
  - macOS: 10.15 (Catalina) 以降
  - Linux: Ubuntu 20.04 LTS 以降

システム要件:
  - RAM: 4GB以上
  - ストレージ: 2GB以上の空き容量
  - CPU: デュアルコア 2GHz以上
  - ネットワーク: AI処理時のインターネット接続
```

## 4. 制約要件（Constraint Requirements）

### **4.1 技術制約**

#### **CR-001: 開発技術制約【必須】**
**要件ID**: CR-001  
**概要**: 使用可能な技術・ライブラリの制限

**詳細制約**:
```yaml
バックエンド:
  - 言語: Go 1.21以上
  - Webフレームワーク: Gin
  - ORM: GORM
  - データベース: SQLite 3.x

AIサービス:
  - 言語: Python 3.10以上  
  - Webフレームワーク: FastAPI
  - AI Framework: LangChain
  - 外部API: OpenAI API、Claude API

フロントエンド:
  - JavaScript: ES2020準拠
  - ライブラリ: htmx（動的UI）
  - CSS: カスタムCSS（フレームワーク不使用）
```

#### **CR-002: データ制約【必須】**  
**要件ID**: CR-002
**概要**: データ容量・件数の制限

**詳細制約**:
```yaml
データ容量制限:
  - ナレッジ総数: 10,000件まで
  - データベースサイズ: 1GBまで
  - 単一テキスト: 50,000文字まで
  - ファイルアップロード: 10MBまで

処理制限:
  - 同時AI処理: 3件まで
  - 検索結果表示: 1,000件まで
  - エクスポートファイル: 100MBまで
```

### **4.2 運用制約**

#### **CR-003: 環境制約【必須】**
**要件ID**: CR-003  
**概要**: 動作環境・デプロイに関する制約

**詳細制約**:
- デプロイ: ローカル環境での手動起動のみ
- 設定: 設定ファイルベースの管理
- ログ: ローカルファイル出力のみ
- バックアップ: 手動バックアップ推奨
- モニタリング: ログベースの監視のみ

#### **CR-004: 外部依存制約【重要】**
**要件ID**: CR-004  
**概要**: 外部サービス・APIに対する制約

**詳細制約**:
```yaml
必須外部依存:
  - OpenAI API: GPT-3.5-turbo以上
  - インターネット接続: AI処理・URL解析時のみ
  - 外部API制限: OpenAI API レート制限（毎分20リクエスト）

オプション外部依存:
  - Claude API: 代替AI処理用
  - 外部Webスクレイピング: 動的コンテンツ取得用
```

#### **CR-005: 開発・運用制約【重要】**
**要件ID**: CR-005  
**概要**: 開発・運用に関する制約

**詳細制約**:
- 開発環境: ローカル開発のみ（クラウド開発環境は使用しない）
- デプロイ: 手動起動のみ（自動デプロイは対象外）
- 監視: ログベースの監視のみ（外部監視ツールは使用しない）
- バックアップ: 手動バックアップ推奨（自動バックアップは基本機能のみ）

## 5. データモデル仕様

### **5.1 ナレッジデータ構造**

#### **DM-001: メインナレッジモデル【必須】**
**要件ID**: DM-001  
**概要**: ナレッジの基本データ構造

**詳細仕様**:
```yaml
Knowledge:
  id: INTEGER PRIMARY KEY AUTOINCREMENT
  title: TEXT NOT NULL (最大255文字)
  summary: TEXT (最大1000文字)
  problem: TEXT (最大5000文字)
  solution: TEXT (最大5000文字)
  result: TEXT (最大5000文字)
  constraint_info: TEXT (最大2000文字)
  insight: TEXT (最大2000文字)
  keywords: TEXT (JSON配列、最大1000文字)
  category: TEXT (最大100文字)
  source_url: TEXT (最大500文字)
  confidence: REAL (0.0-1.0)
  quality_score: INTEGER (0-100)
  estimated_expiry: DATE
  view_count: INTEGER DEFAULT 0
  created_at: DATETIME DEFAULT CURRENT_TIMESTAMP
  updated_at: DATETIME DEFAULT CURRENT_TIMESTAMP
  deleted_at: DATETIME (論理削除用)
```

#### **DM-002: メタデータモデル【重要】**
**要件ID**: DM-002  
**概要**: ナレッジのメタデータ管理

**詳細仕様**:
```yaml
KnowledgeMetadata:
  knowledge_id: INTEGER (外部キー)
  source_type: TEXT (url|text|manual)
  processing_time_ms: INTEGER
  ai_model_version: TEXT
  last_accessed_at: DATETIME
  access_count: INTEGER DEFAULT 0
  related_knowledge_ids: TEXT (JSON配列)
  tags: TEXT (JSON配列)
  custom_fields: TEXT (JSON形式)
```

### **5.2 API仕様**

#### **API-001: REST APIエンドポイント【必須】**
**要件ID**: API-001  
**概要**: システムが提供するAPI仕様

**詳細仕様**:
```yaml
ナレッジ管理API:
  POST /api/knowledge: ナレッジ作成
  GET /api/knowledge/:id: ナレッジ取得
  PUT /api/knowledge/:id: ナレッジ更新
  DELETE /api/knowledge/:id: ナレッジ削除
  GET /api/knowledge: ナレッジ一覧取得

検索API:
  GET /api/knowledge/search: キーワード検索
  GET /api/knowledge/filter: フィルタ検索
  GET /api/knowledge/related/:id: 関連ナレッジ取得

エクスポートAPI:
  POST /api/knowledge/:id/export: 単一ナレッジエクスポート
  POST /api/knowledge/batch-export: 複数ナレッジエクスポート

システムAPI:
  GET /api/health: ヘルスチェック
  GET /api/stats: 統計情報取得
```

#### **API-002: リクエスト・レスポンス形式【必須】**
**要件ID**: API-002  
**概要**: API通信のデータ形式

**詳細仕様**:
```yaml
リクエスト形式:
  Content-Type: application/json
  Accept: application/json
  
レスポンス形式:
  成功時: HTTP 200/201 + JSON
  エラー時: HTTP 4xx/5xx + エラーJSON
  
エラーレスポンス形式:
  {
    "error": true,
    "code": "ERROR_CODE",
    "message": "エラーメッセージ",
    "details": {...},
    "timestamp": "2024-10-20T10:00:00Z"
  }
```

## 6. エラーハンドリング仕様

### **6.1 エラーコード体系**

#### **EH-001: エラーコード定義【必須】**
**要件ID**: EH-001  
**概要**: システム全体のエラーコード体系

**詳細仕様**:
```yaml
システムエラー (1000番台):
  - 1001: INTERNAL_SERVER_ERROR
  - 1002: SERVICE_UNAVAILABLE
  - 1003: DATABASE_ERROR
  - 1004: AI_SERVICE_ERROR

バリデーションエラー (2000番台):
  - 2001: INVALID_INPUT
  - 2002: MISSING_REQUIRED_FIELD
  - 2003: INVALID_FORMAT
  - 2004: SIZE_LIMIT_EXCEEDED

ビジネスロジックエラー (3000番台):
  - 3001: KNOWLEDGE_NOT_FOUND
  - 3002: DUPLICATE_KNOWLEDGE
  - 3003: PROCESSING_FAILED
  - 3004: EXPORT_FAILED

外部依存エラー (4000番台):
  - 4001: OPENAI_API_ERROR
  - 4002: URL_ACCESS_ERROR
  - 4003: NETWORK_ERROR
  - 4004: RATE_LIMIT_EXCEEDED
```

#### **EH-002: エラーメッセージ定義【必須】**
**要件ID**: EH-002  
**概要**: ユーザー向けエラーメッセージ

**詳細仕様**:
```yaml
日本語メッセージ:
  1001: "システムエラーが発生しました。しばらく時間をおいて再度お試しください。"
  2001: "入力内容に問題があります。内容を確認してください。"
  3001: "指定されたナレッジが見つかりません。"
  4001: "AI処理でエラーが発生しました。手動で内容を入力してください。"
  4004: "API利用制限に達しました。しばらく時間をおいてください。"
```

### **6.2 例外処理方針**

#### **EH-003: 例外処理ルール【必須】**
**要件ID**: EH-003  
**概要**: システムの例外処理方針

**詳細仕様**:
- **AI処理失敗**: 手動入力モードにフォールバック
- **データベースエラー**: トランザクションロールバック + エラーログ
- **外部API失敗**: 3回リトライ後、エラーレスポンス
- **タイムアウト**: 30秒でタイムアウト、処理中断
- **データ整合性エラー**: バリデーション失敗、修正要求

## 7. セキュリティ仕様

### **7.1 認証・認可**

#### **SEC-001: 認証方式【必須】**
**要件ID**: SEC-001  
**概要**: システムの認証方式

**詳細仕様**:
```yaml
認証方式:
  - ローカル認証: 設定ファイルベース
  - API認証: 環境変数でのAPIキー管理
  - セッション管理: なし（ローカル動作のため）

認証情報管理:
  - OpenAI API Key: 環境変数 OPENAI_API_KEY
  - 設定ファイル: config.yaml（暗号化推奨）
  - ログ出力: APIキーは除外
```

#### **SEC-002: データ保護【必須】**
**要件ID**: SEC-002  
**概要**: データの保護方式

**詳細仕様**:
```yaml
データ暗号化:
  - 設定ファイル: AES-256暗号化（オプション）
  - データベース: SQLiteの暗号化機能（オプション）
  - 通信: HTTPS必須（外部API通信時）

データアクセス制御:
  - ファイル権限: 600（所有者のみ読み書き）
  - ディレクトリ権限: 700（所有者のみアクセス）
  - ログファイル: 644（読み取り可能）
```

### **7.2 プライバシー保護**

#### **SEC-003: 個人情報保護【必須】**
**要件ID**: SEC-003  
**概要**: 個人情報の取り扱い

**詳細仕様**:
- **データ最小化**: 必要最小限のデータのみ外部送信
- **ログ除外**: 個人情報・機密情報のログ出力禁止
- **データ保持**: 削除要求への対応（30日以内）
- **匿名化**: 統計情報での個人特定情報除外

## 8. テスト要件

### **8.1 単体テスト要件**

#### **TEST-001: 単体テスト仕様【必須】**
**要件ID**: TEST-001  
**概要**: 各コンポーネントの単体テスト

**詳細仕様**:
```yaml
Go コンポーネント:
  - カバレッジ: 80%以上
  - テスト対象: handlers, models, database, ai_client
  - テストツール: testing + testify
  - モック: AI クライアント、データベース

Python コンポーネント:
  - カバレッジ: 80%以上
  - テスト対象: processors, chains, api
  - テストツール: pytest + pytest-cov
  - モック: OpenAI API、外部HTTP
```

#### **TEST-002: 統合テスト仕様【重要】**
**要件ID**: TEST-002  
**概要**: システム全体の統合テスト

**詳細仕様**:
```yaml
テストシナリオ:
  - ナレッジ作成→検索→取得の完全フロー
  - AI処理失敗時のフォールバック
  - 複数ナレッジの並行処理
  - エクスポート機能の動作確認

テストデータ:
  - サンプルURL: 5件
  - サンプルテキスト: 10件
  - エラーケース: 各機能3件以上
```

### **8.2 パフォーマンステスト要件**

#### **TEST-003: 性能テスト仕様【重要】**
**要件ID**: TEST-003  
**概要**: システムの性能テスト

**詳細仕様**:
```yaml
負荷テスト:
  - 同時ナレッジ作成: 5件
  - 同時検索処理: 10件
  - 同時エクスポート: 3件
  - 継続時間: 10分間

性能基準:
  - 応答時間: 要件定義の制限内
  - メモリ使用量: 1GB以下
  - CPU使用率: 50%以下
  - エラー率: 5%以下
```

## 9. 運用・保守要件

### **9.1 バックアップ・復旧**

#### **OPS-001: バックアップ仕様【必須】**
**要件ID**: OPS-001  
**概要**: データのバックアップ方式

**詳細仕様**:
```yaml
バックアップ対象:
  - SQLiteデータベースファイル
  - 設定ファイル
  - エクスポートファイル
  - ログファイル（最新30日分）

バックアップ方式:
  - 手動バックアップ: 推奨（週1回）
  - 自動バックアップ: 日次（基本機能のみ）
  - バックアップ先: ローカルディスク
  - 保持期間: 30日間

復旧手順:
  - データベース復旧: ファイル置換
  - 設定復旧: 設定ファイル復元
  - 動作確認: ヘルスチェック実行
```

#### **OPS-002: ログ管理仕様【必須】**
**要件ID**: OPS-002  
**概要**: ログの管理方式

**詳細仕様**:
```yaml
ログ出力:
  - レベル: DEBUG, INFO, WARN, ERROR
  - 形式: JSON形式
  - 出力先: ファイル + 標準出力
  - ローテーション: 日次、最大30ファイル

ログ内容:
  - アクセスログ: HTTP リクエスト/レスポンス
  - アプリケーションログ: ビジネスロジック
  - エラーログ: 例外・エラー情報
  - パフォーマンスログ: 処理時間・リソース使用量

ログ分析:
  - エラー率監視
  - パフォーマンス監視
  - 利用統計分析
```

### **9.2 監視・アラート**

#### **OPS-003: 監視仕様【重要】**
**要件ID**: OPS-003  
**概要**: システム監視方式

**詳細仕様**:
```yaml
監視対象:
  - アプリケーション稼働状況
  - データベース接続
  - AI サービス接続
  - ディスク使用量
  - メモリ使用量

監視方法:
  - ヘルスチェック: /api/health
  - ログ監視: エラーログの監視
  - リソース監視: システムリソース使用量
  - 手動監視: ユーザーによる確認

アラート条件:
  - アプリケーション停止
  - エラー率 10%以上
  - ディスク使用量 90%以上
  - メモリ使用量 80%以上
```

## 10. 受け入れテスト仕様

### **10.1 受け入れテストシナリオ**

#### **UAT-001: 基本機能テスト【必須】**
**要件ID**: UAT-001  
**概要**: 基本機能の受け入れテスト

**詳細仕様**:
```yaml
テストシナリオ1: ナレッジ作成フロー
  Given: システムが正常に起動している
  When: ユーザーがURL「https://example.com/article」を投入
  Then: 30秒以内にナレッジが作成される
  And: タイトル・要約・キーワードが生成される
  And: 信頼度スコアが0.5以上である

テストシナリオ2: 検索機能
  Given: 複数のナレッジが登録されている
  When: ユーザーが「マーケティング」で検索
  Then: 2秒以内に検索結果が表示される
  And: 関連するナレッジが表示される
  And: 検索語がハイライトされる

テストシナリオ3: エクスポート機能
  Given: ナレッジが作成されている
  When: ユーザーがチェックリスト形式でエクスポート
  Then: 5秒以内にMarkdownファイルが生成される
  And: ファイルがダウンロードされる
  And: 内容が適切にフォーマットされる
```

#### **UAT-002: エラーハンドリングテスト【必須】**
**要件ID**: UAT-002  
**概要**: エラー処理の受け入れテスト

**詳細仕様**:
```yaml
テストシナリオ1: AI処理失敗
  Given: AI サービスが利用できない状態
  When: ユーザーがナレッジ作成を試行
  Then: エラーメッセージが表示される
  And: 手動入力モードに切り替わる
  And: データは失われない

テストシナリオ2: 無効なURL
  Given: システムが正常に動作している
  When: ユーザーが無効なURLを投入
  Then: バリデーションエラーが表示される
  And: 適切なエラーメッセージが表示される
  And: システムがクラッシュしない
```

### **10.2 合格基準**

#### **UAT-003: 受け入れ基準【必須】**
**要件ID**: UAT-003  
**概要**: 受け入れテストの合格基準

**詳細仕様**:
```yaml
機能要件:
  - 全必須機能が正常に動作: 100%
  - 重要機能の動作: 95%以上
  - 任意機能の動作: 80%以上

非機能要件:
  - 応答時間: 要件定義の制限内
  - エラー率: 5%以下
  - メモリ使用量: 1GB以下
  - 稼働率: 99%以上

ユーザビリティ:
  - 基本操作の習得時間: 15分以内
  - 操作ミス率: 10%以下
  - ユーザー満足度: 80%以上
```

## 11. 付録

### **11.1 用語集**

```yaml
タネ: ナレッジの元となる個別具体的な情報
ナレッジ: タネをAI加工した再利用可能な知識
ブロック: ナレッジの構成要素（問題・解決策・結果等）
メタデータ: ナレッジの品質・信頼性・鮮度に関する情報
セマンティック検索: 意味を理解した検索機能
フォールバック: メイン処理失敗時の代替処理
```

### **11.2 参考資料**

- 機能仕様書: knowledge_management_functional_spec.md
- 設計書: knowledge_management_design.md
- プロジェクト概要: knowledge_management_project_overview.md

---

**文書情報**
- 作成日: 2025年9月4日
- バージョン: 0.1
- 最終更新: 2025年9月4日
- 作成者: ich